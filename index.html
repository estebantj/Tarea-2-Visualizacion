<!DOCTYPE html>
<meta charset="utf-8"/>

<html>
    <head>
        <script src="heatmap.js"></script>
        <script src="d3.js"></script>
        <style>
            #heatmap {
                background-image: url(london3.PNG);
                width: 760px;
                height: 600px;
                margin: auto;
            }
            #sidenav {
                width: 250px; /* Set the width of the sidebar */
                height: 100%;
                position: fixed; /* Fixed Sidebar (stay in place on scroll) */
                z-index: 1; /* Stay on top */
                top: 0; /* Stay at the top */
                left: 0;
                background-color: #f1f1f1;
                overflow-x: hidden; /* Disable horizontal scroll */
                padding-top: 20px;
                margin-left: 5
            }
            }
        </style>
    </head>
    
    <body>
        <div id='sidenav'>
            <p>Categoria mayor:</p>
            <select id="selectMajor" class="custom-select" onchange="cambiarCrimenesMenores(this.value)">

            </select>
            
            <p>Categoria menor:</p>
            <select id="selectMinor" class="custom-select">

            </select>

        </div>

        <div id='heatmap'></div>
        
        <script>
            var crimenes = []
            var majorCategories = []
            var minorCategories = []
            var crimenMayorActual = ""

            function leerDatos() {    
                d3.csv("datos.csv").then(function(data) {
                    data.forEach(element => {
                        crimenes.push({
                            borough : element.borough,
                            major : element.major_category,
                            minor : element.minor_category,
                            value : element.value,
                            year : element.year,
                            month : element.month,
                        })
                    });
                    crearMapa()
                })
            }

            function crearMapa() {
                crimenMayorActual = crimenes[0].major
                // Se agregan las opciones al select de categoria mayor
                crimenes.forEach(element => {
                    if ((majorCategories.indexOf(element.major) > -1) == false) {
                        var doc = document.getElementById('selectMajor')
                        var select = document.createElement('option');
                        select.text=element.major
                        doc.add(select, doc[doc.len])
                        majorCategories.push(element.major)

                    }
                    // Se revisa si el crimen menor corresponde al crimen mayor que se encuentra inicialmente
                    if (element.major == crimenMayorActual && (minorCategories.indexOf(element.minor) > -1) == false) {
                        var doc = document.getElementById('selectMinor')
                        var select = document.createElement('option');
                        select.text=element.minor
                        doc.add(select, doc[doc.len])
                        minorCategories.push(element.minor)
                    }

                });
                majorCategories = []
                minorCategories = []
                
                var width = window.screen.availWidth*0.8,
                height = window.screen.availHeight*0.8
                
                // minimal heatmap instance configuration
                var heatmapInstance = h337.create({
                    // only container is required, the rest will be defaults
                    container: document.getElementById('heatmap')
                });
                // now generate some random data
                var points = [];
                var max = 0;
                var len = 100;

                while (len--) {
                    var val = Math.floor(Math.random()*100);
                    max = Math.max(max, val);
                    var point = {
                        x: Math.floor(Math.random()*width),
                        y: Math.floor(Math.random()*height),
                        value: val
                    };
                    points.push(point);
                }
                // heatmap data format
                var data = {
                    max: max,
                    data: points
                };
                // if you have a set of datapoints always use setData instead of addData
                // for data initialization
                heatmapInstance.setData(data);
            }

            function cambiarCrimenesMenores(value) {
                console.log(value)
                crimenMayorActual = value
                var doc = document.getElementById('selectMinor')
                doc.options.length = 0;
                crimenes.forEach(element => {
                    if (element.major == crimenMayorActual && (minorCategories.indexOf(element.minor) > -1) == false) {                        
                        var select = document.createElement('option');
                        select.text=element.minor
                        doc.add(select, doc[doc.len])
                        minorCategories.push(element.minor)
                    }
                });
                minorCategories = []
            }

            leerDatos()
        </script>

    </body>
</html>